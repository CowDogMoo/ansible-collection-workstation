---
- name: Verify
  hosts: all
  gather_facts: true
  vars:
    container_user: "{{ ansible_distribution | lower }}"
    container_home: "/home/{{ container_user }}"
  pre_tasks:
    - name: Set home directory fact
      ansible.builtin.set_fact:
        ansible_env:
          HOME: "{{ container_home }}"
  tasks:
    - name: Include default variables
      ansible.builtin.include_vars:
        file: "../../defaults/main.yml"

    - name: Check if .asdf directory exists
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/.asdf"
      register: asdf_dir
      become: true
      become_user: "{{ container_user }}"

    - name: Assert that .asdf directory exists
      ansible.builtin.assert:
        that:
          - asdf_dir.stat.exists
          - asdf_dir.stat.isdir

    - name: Verify ASDF is accessible
      ansible.builtin.command: "{{ ansible_env.HOME }}/.asdf/bin/asdf --version"
      register: asdf_check
      failed_when: asdf_check.rc != 0
      changed_when: false

    - name: Check installed ASDF plugins and versions
      ansible.builtin.shell: |
        export ASDF_DATA_DIR="{{ ansible_env.HOME }}/.asdf"
        export PATH="${ASDF_DATA_DIR}/bin:$PATH"
        . "${ASDF_DATA_DIR}/asdf.sh"
        asdf plugin list && asdf list
      register: asdf_plugins_versions
      changed_when: false

    - name: Assert that ASDF plugins and versions are installed
      ansible.builtin.assert:
        that:
          - "'golang' in asdf_plugins_versions.stdout"
          - "'1.22.4' in asdf_plugins_versions.stdout"

    - name: Check contents of .tool-versions
      ansible.builtin.command:
        cmd: "cat {{ ansible_env.HOME }}/.tool-versions"
      register: tool_versions_content
      changed_when: false

    - name: Set expected version facts
      ansible.builtin.set_fact:
        expected_golang_version: "{{ asdf_plugins[0].version }}"

    - name: Assert .tool-versions content
      ansible.builtin.assert:
        that:
          - "'golang' in tool_versions_content.stdout"
          - "expected_golang_version in tool_versions_content.stdout"
        fail_msg: "Expected version {{ expected_golang_version }} not found in .tool-versions"
        success_msg: "Found expected golang version {{ expected_golang_version }}"

    - name: Check shell profile setup
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/{{ (available_shell == '/bin/zsh') | ternary('.zshrc', '.bashrc') }}"
      register: shell_profile

    - name: Assert shell profile exists
      ansible.builtin.assert:
        that:
          - shell_profile.stat.exists
          - shell_profile.stat.mode == '0644'

    - name: Check shell profile content
      ansible.builtin.command:
        cmd: "cat {{ ansible_env.HOME }}/{{ (available_shell == '/bin/zsh') | ternary('.zshrc', '.bashrc') }}"
      register: profile_content
      changed_when: false

    - name: Assert shell profile content
      ansible.builtin.assert:
        that:
          - "'ASDF_DATA_DIR=$HOME/.asdf' in profile_content.stdout"
          - "'PATH=\"$ASDF_DATA_DIR/bin:$PATH\"' in profile_content.stdout"