---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Include default variables
      ansible.builtin.include_vars:
        file: "../../defaults/main.yml"

    - name: Include main variables
      ansible.builtin.include_vars:
        file: "../../vars/main.yml"

    - name: Check if global ASDF installation directory exists
      ansible.builtin.stat:
        path: "/opt/asdf"
      register: asdf_global_dir
      when: asdf_global_install | default(false)

    - name: Assert that global ASDF installation directory exists
      ansible.builtin.assert:
        that:
          - asdf_global_dir.stat.exists
          - asdf_global_dir.stat.isdir
      when: asdf_global_install | default(false)

    - name: Check if asdf.sh script exists and is executable
      ansible.builtin.stat:
        path: "/etc/profile.d/asdf.sh"
      register: asdf_script_stat
      when: asdf_global_install | default(false)

    - name: Assert that asdf.sh script exists and is executable
      ansible.builtin.assert:
        that:
          - asdf_script_stat.stat.exists
          - asdf_script_stat.stat.mode | string | match('0?755$')
      when: asdf_global_install | default(false)

    - name: Verify ASDF is accessible globally
      ansible.builtin.command: "/opt/asdf/bin/asdf --version"
      register: asdf_check
      failed_when: asdf_check.rc != 0
      changed_when: false
      when: asdf_global_install | default(false)

    - name: Check installed ASDF plugins and versions
      ansible.builtin.shell: |
        set -o pipefail
        . /etc/profile.d/asdf.sh
        asdf plugin list
        asdf list
      register: asdf_plugins_versions
      changed_when: false
      when: asdf_global_install | default(false)

    - name: Assert that ASDF plugins and versions are installed
      ansible.builtin.assert:
        that:
          - "'golang' in asdf_plugins_versions.stdout"
          - "'1.22.1' in asdf_plugins_versions.stdout"
          - "'kubectl' in asdf_plugins_versions.stdout"
          - "'1.29.3' in asdf_plugins_versions.stdout"
      when: asdf_global_install | default(false)
