---
- name: Install asdf plugins globally
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      . /etc/profile.d/asdf.sh
      {% for user in asdf_users %}
        {% for plugin in user.plugins %}
          plugins=$(asdf plugin list)
          grep -q "{{ plugin.name }}" <<< "$plugins" || asdf plugin add "{{ plugin.name }}"
          asdf install "{{ plugin.name }}" "{{ plugin.version }}"
          asdf global "{{ plugin.name }}" "{{ plugin.version }}"
        {% endfor %}
      {% endfor %}
    executable: /bin/bash
  become: true
  changed_when: false
  when: asdf_global_install | default(false)

- name: Install asdf plugins for each user
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      . "{{ asdf_install_script_path }}" "{{ asdf_user.home }}"
      {% if asdf_user.plugins is defined %}
      {% for plugin in asdf_user.plugins %}
      plugins=$(asdf plugin list)
      grep -q "{{ plugin.name }}" <<< "$plugins" || asdf plugin add "{{ plugin.name }}"
      asdf install "{{ plugin.name }}" "{{ plugin.version }}"
      if [ "{{ plugin.scope }}" = "global" ]; then
        asdf global "{{ plugin.name }}" "{{ plugin.version }}"
      elif [ "{{ plugin.scope }}" = "local" ]; then
        asdf local "{{ plugin.name }}" "{{ plugin.version }}"
      else
        echo "Invalid scope: {{ plugin.scope }}"
        exit 1
      fi
      {% endfor %}
      {% endif %}
    executable: "{{ asdf_user.shell }}"
  loop: "{{ asdf_enriched_users }}"
  loop_control:
    loop_var: asdf_user
    label: "{{ asdf_user.username }}"
  become: true
  become_user: "{{ asdf_user.username }}"
  changed_when: false
  when:
    - not asdf_global_install | default(false)
    - asdf_user.username != 'root'
