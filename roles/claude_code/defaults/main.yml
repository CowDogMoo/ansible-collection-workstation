---
claude_code_username: "{{ ansible_facts['user_id'] | default(ansible_facts['user']) }}"
claude_code_usergroup: "{{ (ansible_facts['os_family'] == 'Darwin') | ternary('staff', claude_code_username) }}"
claude_code_user_home: >-
  {{ (ansible_facts['os_family'] == 'Darwin') | ternary(ansible_facts['env']['HOME'],
     (claude_code_username == 'root') | ternary('/root', '/home/' + claude_code_username)) }}

# Configuration directory for Claude Code
claude_code_config_dir: "{{ claude_code_user_home }}/.claude"

# Homebrew prefix (varies by OS/architecture)
# macOS ARM: /opt/homebrew, macOS Intel: /usr/local, Linux: /home/linuxbrew/.linuxbrew
claude_code_homebrew_prefix: >-
  {{ (ansible_facts['os_family'] == 'Darwin') | ternary(
       (ansible_architecture == 'arm64') | ternary('/opt/homebrew', '/usr/local'),
       '/home/linuxbrew/.linuxbrew') }}

# PATH for claude CLI commands
claude_code_path: "{{ claude_code_homebrew_prefix }}/bin:{{ claude_code_user_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"

# Whether to install Claude Code CLI
claude_code_install: true

# Whether to manage Claude Code settings
claude_code_manage_settings: true

# Whether to backup existing settings before overwriting
claude_code_backup_settings: true

# Simple hooks - easy YAML configuration
claude_code_simple_hooks: []

# Advanced hooks - custom Python/shell scripts
claude_code_advanced_hooks:
  # Hook 1: Block commits/PRs with forbidden content (emojis/branding)
  - event: PreToolUse
    tool: Bash
    type: command
    command: |
      python3 -c "
      import json, sys

      data = json.load(sys.stdin)
      cmd = data.get('tool_input', {}).get('command', '')

      forbidden = ['ü§ñ', 'Generated with', 'Co-Authored-By: Claude', 'claude.com/claude-code']

      msg = ''
      if 'git commit' in cmd and '-m' in cmd and any(f in cmd for f in forbidden):
          msg = '‚ùå BLOCKED: Forbidden content (emojis/branding)\\n\\n‚úÖ Use ONLY fabric output\\nGenerate: git diff --staged | fabric --pattern commit'
      elif 'gh pr create' in cmd and '--body' in cmd and any(f in cmd for f in forbidden):
          msg = '‚ùå BLOCKED: Forbidden content (emojis/branding)\\n\\n‚úÖ Use ONLY fabric output\\nGenerate: git diff main...HEAD | fabric --pattern pr'

      if msg:
          sys.stderr.write(msg + '\n')
          sys.exit(2)
      sys.exit(0)
      "

  # Hook 2: Block dangerous git flags that bypass safety checks
  - event: PreToolUse
    tool: Bash
    type: command
    command: |
      python3 -c "
      import json, sys, re

      data = json.load(sys.stdin)
      cmd = data.get('tool_input', {}).get('command', '')

      if 'git' not in cmd:
          sys.exit(0)

      # Check for dangerous flags (long flags use simple 'in', short flags use regex)
      dangerous_long = ['--no-verify', '--no-gpg-sign', '--no-post-rewrite']
      blocked_flag = next((f for f in dangerous_long if f in cmd), None)

      # Check for -n flag as standalone (not part of --name-only etc)
      if not blocked_flag and re.search(r'(^|\s)-n(\s|$)', cmd):
          blocked_flag = '-n'

      if blocked_flag:
          msg = f'‚ùå BLOCKED: Cannot use {blocked_flag} flag.\\n\\nThis flag bypasses important safety checks.\\nFix the underlying issues instead.'
          sys.stderr.write(msg + '\\n')
          sys.exit(2)
      sys.exit(0)
      "

  # Hook 3: Sound notification when Claude finishes a task
  - event: Stop
    tool: ""
    type: command
    command: "osascript -e 'beep 2'"

  # Hook 4: Sound notification when Claude needs input
  - event: Notification
    tool: ""
    type: command
    command: "osascript -e 'beep 1'"

# Additional settings (optional)
claude_code_additional_settings: {}

# MCP Server Management
claude_code_manage_mcp_servers: true  # Whether to manage MCP servers

# List of MCP servers to install
# Each server supports: name, scope, command, args, env, state
claude_code_mcp_servers: []
# Example:
#   - name: chrome-devtools
#     scope: user  # user or project
#     command: npx
#     args:
#       - "-y"
#       - "chrome-devtools-mcp@latest"
#     state: present  # present or absent
#
#   - name: grafana
#     scope: user
#     command: "{{ claude_code_user_home }}/.local/bin/mcp-grafana"
#     env:
#       GRAFANA_URL: "https://grafana.example.com"
#       GRAFANA_SERVICE_ACCOUNT_TOKEN: "{{ vault_grafana_token }}"
#     state: present
#
#   - name: warpgate
#     scope: user
#     command: "{{ claude_code_user_home }}/go/bin/warpgate-mcp-server"
#     args:
#       - stdio
#     state: present
