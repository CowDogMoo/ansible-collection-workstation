---
- name: Set claude_code username for Kali systems
  ansible.builtin.set_fact:
    claude_code_username: "kali"
  when: ansible_facts['distribution_release'] == "kali-rolling" and claude_code_username is not defined

- name: Ensure claude_code user home directory exists
  ansible.builtin.stat:
    path: "{{ claude_code_user_home }}"
  register: claude_code_home_stat
  changed_when: false

- name: Fail if user home directory doesn't exist
  ansible.builtin.fail:
    msg: "User home directory {{ claude_code_user_home }} does not exist"
  when: not claude_code_home_stat.stat.exists

- name: Install Claude Code on macOS
  ansible.builtin.include_tasks: install-macos.yml
  when:
    - ansible_facts['os_family'] == 'Darwin'
    - claude_code_install | bool

- name: Install Claude Code on Linux
  ansible.builtin.include_tasks: install-linux.yml
  when:
    - ansible_facts['os_family'] != 'Darwin'
    - ansible_facts['os_family'] != 'Windows'
    - claude_code_install | bool

- name: Install Claude Code on Windows
  ansible.builtin.include_tasks: install-windows.yml
  when:
    - ansible_facts['os_family'] == 'Windows'
    - claude_code_install | bool

- name: Create Claude Code configuration directory
  ansible.builtin.file:
    path: "{{ claude_code_config_dir }}"
    state: directory
    owner: "{{ claude_code_username }}"
    group: "{{ claude_code_usergroup }}"
    mode: "0755"
  become: "{{ ansible_facts['os_family'] != 'Darwin' }}"

- name: Check if settings.json will change (dry-run)
  ansible.builtin.template:
    src: settings.json.j2
    dest: "{{ claude_code_config_dir }}/settings.json"
    owner: "{{ claude_code_username }}"
    group: "{{ claude_code_usergroup }}"
    mode: "0644"
  check_mode: true
  become: "{{ ansible_facts['os_family'] != 'Darwin' }}"
  when: claude_code_manage_settings | bool
  register: claude_code_settings_check
  changed_when: false
  diff: false

- name: Create backup of existing settings.json in /tmp
  ansible.builtin.copy:
    src: "{{ claude_code_config_dir }}/settings.json"
    dest: "/tmp/settings.json.{{ ansible_date_time.iso8601_basic_short }}.backup"
    owner: "{{ claude_code_username }}"
    group: "{{ claude_code_usergroup }}"
    mode: "0644"
    remote_src: true
  become: "{{ ansible_facts['os_family'] != 'Darwin' }}"
  when:
    - claude_code_manage_settings | bool
    - claude_code_backup_settings | bool
    - claude_code_settings_check is changed
  register: claude_code_backup_result

- name: Generate Claude Code settings.json
  ansible.builtin.template:
    src: settings.json.j2
    dest: "{{ claude_code_config_dir }}/settings.json"
    owner: "{{ claude_code_username }}"
    group: "{{ claude_code_usergroup }}"
    mode: "0644"
  become: "{{ ansible_facts['os_family'] != 'Darwin' }}"
  when: claude_code_manage_settings | bool
  register: claude_code_settings_result

- name: Display configuration status
  ansible.builtin.debug:
    msg: >-
      Settings: {{ claude_code_config_dir }}/settings.json |
      Hooks: {{ (claude_code_simple_hooks | length) + (claude_code_advanced_hooks | length) }}
      ({{ claude_code_simple_hooks | length }} simple, {{ claude_code_advanced_hooks | length }} advanced)
      {% if claude_code_backup_result.dest is defined %}| Backup: {{ claude_code_backup_result.dest }}{% endif %}
