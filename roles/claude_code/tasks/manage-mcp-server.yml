---
# tasks/manage-mcp-server.yml

- name: Check if MCP server exists - {{ mcp_server.name }}
  ansible.builtin.set_fact:
    claude_code_mcp_server_exists: "{{ mcp_server.name in claude_code_mcp_list.stdout }}"

- name: Remove MCP server - {{ mcp_server.name }}
  ansible.builtin.command:
    cmd: "claude mcp remove {{ mcp_server.name }} -s {{ mcp_server.scope | default('user') }}"
  environment:
    HOME: "{{ claude_code_user_home }}"
    PATH: "{{ claude_code_path }}"
  when:
    - mcp_server.state | default('present') == 'absent'
    - claude_code_mcp_server_exists | bool
  changed_when: true
  become: "{{ ansible_facts['os_family'] != 'Darwin' }}"
  become_user: "{{ claude_code_username }}"

- name: Identify 1Password lookups - {{ mcp_server.name }}
  ansible.builtin.set_fact:
    claude_code_mcp_op_lookups: >-
      {{ mcp_server.env | default({}) | dict2items
         | selectattr('value', 'match', '^OP_LOOKUP:')
         | list }}
    claude_code_mcp_plain_env: >-
      {{ mcp_server.env | default({}) | dict2items
         | rejectattr('value', 'match', '^OP_LOOKUP:')
         | items2dict }}
  when:
    - mcp_server.state | default('present') == 'present'
    - not claude_code_mcp_server_exists | bool

- name: Resolve 1Password secret for {{ mcp_server.name }}
  ansible.builtin.command:
    cmd: "op read '{{ item.value | regex_replace('^OP_LOOKUP:', '') }}'"
  register: claude_code_mcp_op_result
  loop: "{{ claude_code_mcp_op_lookups | default([]) }}"
  loop_control:
    label: "{{ item.key }}"
  when:
    - mcp_server.state | default('present') == 'present'
    - not claude_code_mcp_server_exists | bool
    - claude_code_mcp_op_lookups | default([]) | length > 0
  changed_when: false
  no_log: true

- name: Build resolved environment - {{ mcp_server.name }}
  ansible.builtin.set_fact:
    claude_code_mcp_resolved_env: >-
      {{ claude_code_mcp_plain_env | default({}) | combine(
           dict(claude_code_mcp_op_lookups | default([]) | map(attribute='key')
                | zip(claude_code_mcp_op_result.results | default([]) | map(attribute='stdout')))
         ) }}
  when:
    - mcp_server.state | default('present') == 'present'
    - not claude_code_mcp_server_exists | bool
    - claude_code_mcp_op_lookups | default([]) | length > 0
  no_log: true

- name: Use plain environment - {{ mcp_server.name }}
  ansible.builtin.set_fact:
    claude_code_mcp_resolved_env: "{{ mcp_server.env | default({}) }}"
  when:
    - mcp_server.state | default('present') == 'present'
    - not claude_code_mcp_server_exists | bool
    - claude_code_mcp_op_lookups | default([]) | length == 0
  no_log: true

- name: Build MCP add command - {{ mcp_server.name }}
  ansible.builtin.set_fact:
    claude_code_mcp_add_cmd: >-
      claude mcp add {{ mcp_server.name }}
      --scope {{ mcp_server.scope | default('user') }}
      {% for key, value in (claude_code_mcp_resolved_env | default(mcp_server.env | default({}))).items() %}
      -e {{ key }}={{ value }}
      {% endfor %}
      -- {{ mcp_server.command }}
      {% if mcp_server.args is defined %}
      {{ mcp_server.args | join(' ') }}
      {% endif %}
  when: mcp_server.state | default('present') == 'present'
  no_log: true

- name: Add MCP server - {{ mcp_server.name }}
  ansible.builtin.command:
    cmd: "{{ claude_code_mcp_add_cmd }}"
  environment:
    HOME: "{{ claude_code_user_home }}"
    PATH: "{{ claude_code_path }}"
  when:
    - mcp_server.state | default('present') == 'present'
    - not claude_code_mcp_server_exists | bool
  changed_when: true
  become: "{{ ansible_facts['os_family'] != 'Darwin' }}"
  become_user: "{{ claude_code_username }}"
  no_log: true

- name: Clear resolved env for next iteration
  ansible.builtin.set_fact:
    claude_code_mcp_resolved_env: {}
    claude_code_mcp_op_lookups: []
    claude_code_mcp_plain_env: {}
    claude_code_mcp_op_result: {}
