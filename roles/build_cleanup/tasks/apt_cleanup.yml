---
# APT cleanup
# ===========
# Cleans up APT package manager caches, lists, and temporary files
# to reduce image size.

- name: Run apt-get clean
  ansible.builtin.apt:
    clean: true
  become: true
  failed_when: false

- name: Run apt-get autoclean
  ansible.builtin.apt:
    autoclean: true
  become: true
  failed_when: false

- name: Run apt-get autoremove
  ansible.builtin.apt:
    autoremove: true
    purge: true
  become: true
  failed_when: false

- name: Remove APT cache files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/cache/apt/archives
    - /var/cache/apt/pkgcache.bin
    - /var/cache/apt/srcpkgcache.bin
  become: true
  failed_when: false

- name: Remove APT lists
  ansible.builtin.file:
    path: /var/lib/apt/lists
    state: absent
  become: true
  failed_when: false

- name: Recreate APT lists directory (required for future apt operations)
  ansible.builtin.file:
    path: /var/lib/apt/lists
    state: directory
    mode: '0755'
  become: true
  failed_when: false

- name: Recreate APT archives directory
  ansible.builtin.file:
    path: /var/cache/apt/archives
    state: directory
    mode: '0755'
  become: true
  failed_when: false

- name: Remove dpkg status files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/dpkg/status-old
    - /var/lib/dpkg/available-old
  become: true
  failed_when: false

- name: Remove downloaded package files
  ansible.builtin.shell: |
    rm -f /var/cache/apt/archives/*.deb
    rm -f /var/cache/apt/archives/partial/*.deb
  become: true
  changed_when: false
  failed_when: false

- name: Display APT cleanup summary
  ansible.builtin.debug:
    msg: |
      APT cleanup complete:
      - Ran apt-get clean, autoclean, and autoremove
      - Removed APT cache files and lists
      - Removed dpkg status files
      - Recreated required directories
