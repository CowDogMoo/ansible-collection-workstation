---
# Molecule scenario for testing deep cleanup with preserve_includes: true
dependency:
  name: galaxy
  options:
    role-file: ../../requirements.yml
    requirements-file: ../../requirements.yml

driver:
  name: docker

platforms:
  - name: ubuntu-deep-cleanup-preserve-test
    image: "geerlingguy/docker-ubuntu2404-ansible:latest"
    command: ""
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    privileged: true

provisioner:
  name: ansible
  config_file: ${MOLECULE_PROJECT_DIRECTORY}/../../ansible.cfg
  playbooks:
    converge: ${MOLECULE_PLAYBOOK:-converge.yml}

verifier:
  name: ansible

# Skip idempotence - deep cleanup operations are inherently not idempotent
# (e.g., /var/tmp removal/recreation always shows as changed)
scenario:
  test_sequence:
    - dependency
    - cleanup
    - destroy
    - syntax
    - create
    - prepare
    - converge
    - verify
    - cleanup
    - destroy
