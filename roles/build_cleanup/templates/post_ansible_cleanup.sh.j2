#!/bin/bash
#
# Post-Ansible Cleanup Script
# ============================
# Generated by: cowdogmoo.workstation.build_cleanup role
# Generated at: {{ ansible_date_time.iso8601 | default('unknown') }}
# Purpose: Clean up artifacts that Ansible cannot remove while running
#
# This script should be executed by Packer AFTER the Ansible provisioner completes.

set -e

echo "========================================"
echo "Post-Ansible Cleanup Script"
echo "========================================"
echo "Generated by: build_cleanup role"
echo "Install path: {{ build_cleanup_install_path }}"
echo "User: {{ build_cleanup_username }}"
echo "========================================"
echo ""

# Remove Ansible runtime artifacts (Ansible can't delete itself)
echo "[1/7] Removing Ansible artifacts..."
rm -rf {{ build_cleanup_user_home }}/.ansible || true
rm -rf /root/.ansible || true
rm -rf /tmp/ansible* || true
echo "  ✓ Ansible artifacts removed"

# Remove Packer temporary files
echo "[2/7] Removing Packer artifacts..."
rm -rf /tmp/packer* || true
echo "  ✓ Packer artifacts removed"

# Ensure binary permissions are correct
{% if build_cleanup_keep_binaries is defined and build_cleanup_keep_binaries | length > 0 %}
echo "[3/7] Ensuring binary permissions..."
{% for binary in build_cleanup_keep_binaries %}
if [ -f "{{ build_cleanup_install_path }}/{{ binary }}" ]; then
  chmod 755 {{ build_cleanup_install_path }}/{{ binary }} 2>/dev/null || true
  chown {{ build_cleanup_username }}:{{ build_cleanup_username }} {{ build_cleanup_install_path }}/{{ binary }} 2>/dev/null || true
  echo "  ✓ Set permissions for {{ binary }}"
fi
{% endfor %}
{% else %}
echo "[3/7] No binaries to set permissions for"
{% endif %}

# Clear shell history (security)
{% if build_cleanup_clear_histories | bool %}
echo "[4/7] Clearing shell histories..."
rm -f {{ build_cleanup_user_home }}/.bash_history || true
rm -f {{ build_cleanup_user_home }}/.wget-hsts || true
rm -f {{ build_cleanup_user_home }}/.zsh_history || true
rm -f /root/.bash_history || true
rm -f /root/.wget-hsts || true
rm -f /root/.zsh_history || true
history -c 2>/dev/null || true
echo "  ✓ Shell histories cleared"
{% else %}
echo "[4/7] Skipping shell history cleanup (disabled)"
{% endif %}

# Final apt cleanup (belt and suspenders)
{% if build_cleanup_final_apt_cleanup | bool and ansible_os_family == "Debian" %}
echo "[5/7] Final APT cleanup..."
apt-get clean || true
rm -rf /var/lib/apt/lists/* || true
rm -rf /var/cache/apt/* || true
echo "  ✓ APT cleanup complete"
{% else %}
echo "[5/7] Skipping APT cleanup (disabled or not Debian)"
{% endif %}

# Clear all temp directories
{% if build_cleanup_final_temp_cleanup | bool %}
echo "[6/7] Clearing temporary directories..."
rm -rf /tmp/* /var/tmp/* || true
echo "  ✓ Temporary directories cleared"
{% else %}
echo "[6/7] Skipping temp cleanup (disabled)"
{% endif %}

# Force filesystem sync
{% if build_cleanup_final_sync | bool %}
echo "[7/7] Syncing filesystem..."
sync
echo "  ✓ Filesystem synced"
{% else %}
echo "[7/7] Skipping filesystem sync (disabled)"
{% endif %}

echo ""
echo "========================================"
echo "Post-Ansible Cleanup Complete!"
echo "========================================"
echo "Summary:"
echo "  - Removed Ansible and Packer artifacts"
{% if build_cleanup_keep_binaries | length > 0 %}
echo "  - Set permissions for {{ build_cleanup_keep_binaries | length }} binaries"
{% endif %}
{% if build_cleanup_clear_histories | bool %}
echo "  - Cleared shell histories"
{% endif %}
{% if build_cleanup_final_apt_cleanup | bool and ansible_os_family == "Debian" %}
echo "  - Ran final APT cleanup"
{% endif %}
{% if build_cleanup_final_temp_cleanup | bool %}
echo "  - Cleared temporary directories"
{% endif %}
{% if build_cleanup_final_sync | bool %}
echo "  - Synced filesystem"
{% endif %}
echo "========================================"

exit 0
