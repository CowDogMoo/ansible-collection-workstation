---
- name: Set default username for macOS systems
  ansible.builtin.set_fact:
    user_setup_default_username: "{{ ansible_env.USER }}"
  when: ansible_os_family == 'Darwin'

- name: Determine default group for macOS systems
  ansible.builtin.command: id -gn
  register: macos_default_group
  when: ansible_os_family == 'Darwin'
  changed_when: false

- name: Set default group for macOS systems
  ansible.builtin.set_fact:
    user_setup_default_group: "{{ macos_default_group.stdout }}"
  when: ansible_os_family == 'Darwin'

- name: Gather the list of unique shells to install
  ansible.builtin.set_fact:
    unique_shells: "{{ user_setup_default_users | map(attribute='shell') | unique | map('regex_replace', '^/bin/(.*)$', '\\1') | list }}"
  tags: always

- name: Install base packages
  become: true
  ansible.builtin.package:
    name: "{{ user_setup_install_packages }}"
    state: present
    update_cache: true
  environment: "{{ (ansible_os_family == 'Debian') | ternary({'DEBIAN_FRONTEND': 'noninteractive'}, {}) }}"
  tags: packages

- name: Install user-specific shells
  become: true
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ unique_shells }}"
  when: item != '' and item != 'bash'
  environment:
    DEBIAN_FRONTEND: "{{ 'noninteractive' if ansible_distribution == 'Debian' else '' }}"
  tags: shells

- name: Ensure groups exist for users
  become: true
  ansible.builtin.group:
    name: "{{ item.usergroup }}"
    state: present
  loop: "{{ user_setup_default_users }}"
  when: item.usergroup is defined and item.usergroup != ''
  tags: group-setup

- name: Create users
  become: true
  ansible.builtin.user:
    name: "{{ item.username }}"
    group: "{{ (item.username == user_setup_default_username) | ternary(user_setup_default_group, item.usergroup) }}"
    shell: "{{ item.shell }}"
  loop: "{{ user_setup_default_users }}"
  when: item.username == user_setup_default_username
  tags: user-setup

- name: Provide sudoers access for relevant users in sudoers.d
  become: true
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ item.username }}"
    content: "{{ item.username }} ALL=(ALL:ALL) NOPASSWD:ALL\n"
    validate: "visudo -cf %s"
    mode: "0440"
  when: item.sudo
  loop: "{{ user_setup_default_users }}"
  tags: sudo-setup
