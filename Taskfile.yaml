---
version: "3"

includes:
  pre-commit: .taskfiles/pre-commit.yaml
  changelog: .taskfiles/changelog.yaml
  molecule: .taskfiles/molecule.yaml
  ansible_lint: .taskfiles/ansible_lint.yaml

tasks:
  default:
    desc: "Run all CI tasks"
    cmds:
      - task: ansible_lint:lint-ansible
      - task: run-pre-commit
      - task: molecule:run-molecule-tests

  act:
    desc: "Run GitHub Actions workflow using act"
    cmds:
      - |
        if [[ $(uname -s) == "Darwin" ]] && [[ $(uname -m) == "arm64" ]]; then
          act -W .github/workflows/molecule.yaml --container-architecture linux/arm64
        else
          act -W .github/workflows/molecule.yaml
        fi
    silent: true

  run-pre-commit:
    desc: "Update, clear cache, and run pre-commit hooks"
    cmds:
      - task: pre-commit:update-hooks
      - task: pre-commit:clear-cache
      - task: pre-commit:run-hooks

  gen-changelog:
    desc: "Generate the changelog for the next release"
    cmds:
      - |
        if [ -z "$NEXT_VERSION" ]; then
          echo "'NEXT_VERSION' environment variable not set. Example: NEXT_VERSION=1.0.0"
          exit 1
        fi
      - echo "Generating changelog for release $NEXT_VERSION"
      - task: changelog:lint
      - task: changelog:release

  create-release:
    desc: "Create a release on GitHub"
    cmds:
      - |
        if [ -z "$NEXT_VERSION" ]; then
          echo "'NEXT_VERSION' environment variable not set. Example: NEXT_VERSION=1.0.0"
          exit 1
        fi
      - echo "Creating release $NEXT_VERSION"
      - gh release create $NEXT_VERSION -F changelogs/CHANGELOG.rst
