---
# Fabric custom patterns configuration
fabric_install_custom_patterns: true
fabric_custom_patterns_repo: "~/cowdogmoo/fabric-patterns-hub"
fabric_custom_patterns_symlink: true
fabric_update_custom_patterns: true

# MCP Server configuration for Claude Code
claude_code_mcp_servers:
  # Browser automation via Chrome DevTools
  - name: chrome-devtools
    scope: user
    command: npx
    args:
      - "-y"
      - "chrome-devtools-mcp@latest"

  # Grafana integration for dashboards, alerts, and observability
  - name: grafana
    scope: user
    command: "{{ ansible_env.HOME }}/.local/bin/mcp-grafana"
    env:
      GRAFANA_URL: "{{ grafana_url | default('https://grafana.techvomit.xyz') }}"
      GRAFANA_SERVICE_ACCOUNT_TOKEN: "{{ vault_grafana_api_token }}"

  # Warpgate for container/AMI image building
  - name: warpgate
    scope: user
    command: "{{ ansible_env.HOME }}/go/bin/warpgate-mcp-server"
    args:
      - stdio

claude_code_advanced_hooks:
  # Hook 1: Block commits/PRs with forbidden content (emojis/branding)
  - event: PreToolUse
    tool: Bash
    type: command
    command: |
      python3 -c "
      import json, sys

      data = json.load(sys.stdin)
      cmd = data.get('tool_input', {}).get('command', '')

      forbidden = ['ü§ñ', 'Generated with', 'Co-Authored-By: Claude', 'claude.com/claude-code']

      msg = ''
      if 'git commit' in cmd and '-m' in cmd and any(f in cmd for f in forbidden):
          msg = '‚ùå BLOCKED: Forbidden content (emojis/branding)\\n\\n‚úÖ Use ONLY fabric output\\nGenerate: git diff --staged | fabric --pattern commit'
      elif 'gh pr create' in cmd and '--body' in cmd and any(f in cmd for f in forbidden):
          msg = '‚ùå BLOCKED: Forbidden content (emojis/branding)\\n\\n‚úÖ Use ONLY fabric output\\nGenerate: git diff main...HEAD | fabric --pattern pr'

      if msg:
          sys.stderr.write(msg + '\n')
          sys.exit(2)
      sys.exit(0)
      "

  # Hook 2: Block dangerous git flags that bypass safety checks
  - event: PreToolUse
    tool: Bash
    type: command
    command: |
      python3 -c "
      import json, sys, re

      data = json.load(sys.stdin)
      cmd = data.get('tool_input', {}).get('command', '')

      if 'git' not in cmd:
          sys.exit(0)

      # Check for dangerous flags (long flags use simple 'in', short flags use regex)
      dangerous_long = ['--no-verify', '--no-gpg-sign', '--no-post-rewrite']
      blocked_flag = next((f for f in dangerous_long if f in cmd), None)

      # Check for -n flag as standalone (not part of --name-only etc)
      if not blocked_flag and re.search(r'(^|\s)-n(\s|$)', cmd):
          blocked_flag = '-n'

      if blocked_flag:
          msg = f'‚ùå BLOCKED: Cannot use {blocked_flag} flag.\\n\\nThis flag bypasses important safety checks.\\nFix the underlying issues instead.'
          sys.stderr.write(msg + '\\n')
          sys.exit(2)
      sys.exit(0)
      "

  # Hook 3: Sound notification when Claude finishes a task
  - event: Stop
    tool: ""
    type: command
    command: "afplay \"$HOME/Jobs Done.mp3\""

  # Hook 4: Sound notification when Claude needs input
  - event: Notification
    tool: ""
    type: command
    command: "osascript -e 'beep 1'"

# Additional settings not covered by hooks
claude_code_additional_settings:
  enabledPlugins:
    frontend-design@claude-plugins-official: true
