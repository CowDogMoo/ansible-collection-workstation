---
- name: Workstation
  become: true
  become_user: ubuntu
  remote_user: ubuntu
  hosts: all
  vars:
    ansible_connection: community.aws_ssm
    ansible_aws_ssm_bucket_name: l-bbh
    ansible_aws_ssm_region: us-west-1
    # When the S3 bucket isn't in the same region as the Instance
    # Explicitly setting the addressing style to 'virtual' may be necessary
    # https://repost.aws/knowledge-center/s3-http-307-response
    ansible_aws_ssm_s3_addressing_style: virtual
  tasks:
    - name: Get primary group name of the current user
      ansible.builtin.command: id -gn "{{ ansible_user_id }}"
      changed_when: false
      register: primary_group_name

    - name: Check if user exists
      ansible.builtin.command: id "{{ ansible_user_id }}"
      register: user_exists
      changed_when: false
      failed_when: user_exists.rc not in [0, 1]

    - name: Check if user home directory exists
      ansible.builtin.stat:
        path: "{{ '/Users' if ansible_distribution == 'MacOSX' else '/home' }}/{{ ansible_user_id }}"
      register: home_dir_exists
      changed_when: false
